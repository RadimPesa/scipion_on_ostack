- name: Deploy on OpenStack
  hosts: localhost
  gather_facts: false
  vars:
    os_image: "MU-CentOS-7-64-bit"
    flavor_name: "m1.medium"
    network_name: "private"
    key_name: "debian"
    volume_name: "scipion_volume_ng"
    master_name: "masterng"
    worker_name: "workerng"
    count: 5

  tasks:
    - name: Create a volume
      os_volume:
        state: present
        size: 50
        display_name: "{{ volume_name }}"

    - name: Deploy a master
      os_server:
        state: present
        name: "{{ master_name }}"
        image: "{{ os_image }}"
        key_name: "{{ key_name }}"
        wait: yes
        flavor: "{{ flavor_name }}"
        auto_floating_ip: yes
        network: "{{ network_name }}"
        security_groups: default,ssh_sg
        meta:
          hostname: "{{ master_name }}.localdomain"
        volumes:
        - "{{ volume_name }}"
      register: master
    - set_fact: master_ip="{{master.server.public_v4}}"
    - name: Wait for SSH on the Instance
      command: >
        ssh -oBatchMode=yes -oStrictHostKeyChecking=no
        centos@{{master.server.public_v4}} true
      register: result
      until: result|success
      retries: 5
      delay: 10
#    - debug:
#        msg: "{{master_ip}}"
    - name: Add master to inventory
      add_host: name=master groups=master_servers
                ansible_ssh_host={{ master.server.public_v4 }}


    - name: Deploy worker nodes
      os_server:
        state: present
        name: "{{ worker_name }}{{ item }}"
        flavor: "{{ flavor_name }}"
        auto_floating_ip: yes
        image: "{{ os_image }}"
        key_name: "{{ key_name }}"
        network: "{{ network_name }}"
        security_groups: default,ssh_sg
        meta:
          hostname: "{{ master_name }}{{ item }}.localdomain"
#      register: workerng{{ item }}
      register: newnodes
      with_sequence:
        count={{ count }}

    - name: Add worker nodes to inventory
      add_host: name={{ item.server.public_v4 }}
                groups=worker_servers
                instance_name={{ item.server.name }}
      with_items: "{{ newnodes.results }}"


- hosts: master_servers
  remote_user: centos
  sudo: yes
  roles:
    - update-system
    - master-config
    - nfs
    - scipion-prerequisities
    - scipion
    - ssh


- hosts: worker_servers
  remote_user: centos
  sudo: yes
  pre_tasks:
    - name: "Wait for SSH banners"
      local_action: wait_for port=22 host="{{ inventory_hostname }}" search_regex=OpenSSH delay=5
      become: False
  roles:
    - update-system
    - nfs
    - worker-config
    - scipion-prerequisities
    - ssh
